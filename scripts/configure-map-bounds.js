#!/usr/bin/env node

/**
 * Script to help configure map bounds for GPS coordinate transformation
 * 
 * This script helps you:
 * 1. Calculate proper map bounds from your location data
 * 2. Test GPS to map coordinate transformations
 * 3. Validate that your GPS coordinates map correctly to your indoor coordinate system
 * 
 * Usage:
 *   node scripts/configure-map-bounds.js
 */

const fs = require('fs');
const path = require('path');

// Colors for terminal output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  red: '\x1b[31m',
};

function log(message, color = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

function header(message) {
  console.log('\n' + '='.repeat(60));
  log(message, colors.bright + colors.blue);
  console.log('='.repeat(60) + '\n');
}

/**
 * Calculate map bounds from location data
 */
function calculateBoundsFromLocations() {
  header('üìç Calculate Map Bounds from Locations');
  
  log('This will analyze your locations and suggest map bounds.', colors.yellow);
  log('Make sure your locations in DatabaseService have GPS coordinates!\n');
  
  // Sample locations with GPS coordinates (example data)
  const exampleLocations = [
    { id: 'parking_01', name: 'Parking Lot', x: 10, y: 5, latitude: 37.4220, longitude: -122.0850 },
    { id: 'library', name: 'Library', x: 20, y: 15, latitude: 37.4222, longitude: -122.0845 },
    { id: 'cafeteria', name: 'Cafeteria', x: 30, y: 25, latitude: 37.4224, longitude: -122.0840 },
    { id: 'classroom_a', name: 'Classroom Block A', x: 5, y: 20, latitude: 37.4218, longitude: -122.0855 },
  ];
  
  log('Example locations:', colors.green);
  exampleLocations.forEach(loc => {
    console.log(`  ${loc.name}: (${loc.x}, ${loc.y}) -> (${loc.latitude}, ${loc.longitude})`);
  });
  
  // Calculate bounds
  const latitudes = exampleLocations.map(loc => loc.latitude);
  const longitudes = exampleLocations.map(loc => loc.longitude);
  const xCoords = exampleLocations.map(loc => loc.x);
  const yCoords = exampleLocations.map(loc => loc.y);
  
  const bounds = {
    north: Math.max(...latitudes),
    south: Math.min(...latitudes),
    east: Math.max(...longitudes),
    west: Math.min(...longitudes),
    mapWidth: Math.max(...xCoords) - Math.min(...xCoords),
    mapHeight: Math.max(...yCoords) - Math.min(...yCoords),
  };
  
  log('\nüìä Calculated Map Bounds:', colors.bright);
  console.log(JSON.stringify(bounds, null, 2));
  
  log('\nüí° To use these bounds:', colors.yellow);
  log('1. Copy the bounds object above');
  log('2. Update DEFAULT_MAP_BOUNDS in src/config/mapConfig.ts');
  log('3. Adjust mapWidth and mapHeight if needed\n');
  
  return bounds;
}

/**
 * Test GPS to Map coordinate transformation
 */
function testGPSTransformation() {
  header('üß™ Test GPS Coordinate Transformation');
  
  // Example bounds (replace with your actual bounds)
  const bounds = {
    north: 37.4225,
    south: 37.4200,
    east: -122.0830,
    west: -122.0860,
    mapWidth: 200,
    mapHeight: 200,
  };
  
  // GPS to Map transformation function (same as LocationService)
  function gpsToMapCoordinates(latitude, longitude, bounds) {
    const x = ((longitude - bounds.west) / (bounds.east - bounds.west)) * bounds.mapWidth;
    const y = ((bounds.north - latitude) / (bounds.north - bounds.south)) * bounds.mapHeight;
    return { x, y };
  }
  
  log('Current map bounds:', colors.blue);
  console.log(JSON.stringify(bounds, null, 2));
  
  // Test coordinates
  const testPoints = [
    { name: 'Northwest Corner', lat: bounds.north, lon: bounds.west },
    { name: 'Northeast Corner', lat: bounds.north, lon: bounds.east },
    { name: 'Southwest Corner', lat: bounds.south, lon: bounds.west },
    { name: 'Southeast Corner', lat: bounds.south, lon: bounds.east },
    { name: 'Center', lat: (bounds.north + bounds.south) / 2, lon: (bounds.east + bounds.west) / 2 },
  ];
  
  log('\nüéØ Test Transformations:', colors.green);
  testPoints.forEach(point => {
    const mapCoords = gpsToMapCoordinates(point.lat, point.lon, bounds);
    console.log(`\n  ${point.name}:`);
    console.log(`    GPS: (${point.lat.toFixed(6)}, ${point.lon.toFixed(6)})`);
    console.log(`    Map: (${mapCoords.x.toFixed(2)}, ${mapCoords.y.toFixed(2)})`);
  });
  
  log('\n‚úÖ Expected results:', colors.yellow);
  log('  - Corners should map to (0,0), (width,0), (0,height), (width,height)');
  log('  - Center should be near (width/2, height/2)');
  log('  - All coordinates should be positive and within map bounds\n');
}

/**
 * Generate configuration template
 */
function generateConfigTemplate() {
  header('üìù Generate Configuration Template');
  
  const template = `
/**
 * Map Configuration for Your Campus
 * Generated by configure-map-bounds.js
 */

export const CAMPUS_MAP_BOUNDS = {
  // TODO: Update these with your actual campus GPS coordinates
  // To find these values:
  // 1. Go to the northwest corner of your campus
  // 2. Note GPS coordinates (north, west)
  // 3. Go to the southeast corner
  // 4. Note GPS coordinates (south, east)
  
  north: 37.4225,    // ‚Üê Update: Northernmost latitude
  south: 37.4200,    // ‚Üê Update: Southernmost latitude
  east: -122.0830,   // ‚Üê Update: Easternmost longitude
  west: -122.0860,   // ‚Üê Update: Westernmost longitude
  
  // Coordinate system dimensions (in meters or map units)
  mapWidth: 200,     // ‚Üê Update: Match your x-coordinate range
  mapHeight: 200,    // ‚Üê Update: Match your y-coordinate range
};

/**
 * How to find your campus GPS coordinates:
 * 
 * Method 1: Use Google Maps
 * - Right-click on the location
 * - Copy coordinates (first is latitude, second is longitude)
 * 
 * Method 2: Use your phone
 * - Install a GPS app (e.g., GPS Status)
 * - Walk to each corner and note coordinates
 * 
 * Method 3: From existing QR codes
 * - If you have GPS data in your QR codes, extract from there
 */
`;
  
  log(template, colors.green);
  log('Copy the above configuration and update with your actual values!\n', colors.yellow);
}

/**
 * Validate current configuration
 */
function validateConfiguration() {
  header('‚úì Validate Current Configuration');
  
  try {
    // Try to read the current config
    const configPath = path.join(__dirname, '../src/config/mapConfig.ts');
    if (!fs.existsSync(configPath)) {
      log('‚ùå Configuration file not found!', colors.red);
      log(`Expected location: ${configPath}\n`, colors.yellow);
      return;
    }
    
    const configContent = fs.readFileSync(configPath, 'utf8');
    log('‚úÖ Configuration file found', colors.green);
    log(`Location: ${configPath}\n`, colors.blue);
    
    // Check for TODO comments (indicates default values)
    if (configContent.includes('TODO:') || configContent.includes('Example coordinates')) {
      log('‚ö†Ô∏è  Warning: Configuration contains default/example values', colors.yellow);
      log('   Please update with your actual campus GPS coordinates!\n');
    } else {
      log('‚úÖ Configuration appears to be customized\n', colors.green);
    }
    
    // Extract bounds values (basic parsing)
    const northMatch = configContent.match(/north:\s*([-\d.]+)/);
    const southMatch = configContent.match(/south:\s*([-\d.]+)/);
    const eastMatch = configContent.match(/east:\s*([-\d.]+)/);
    const westMatch = configContent.match(/west:\s*([-\d.]+)/);
    
    if (northMatch && southMatch && eastMatch && westMatch) {
      const bounds = {
        north: parseFloat(northMatch[1]),
        south: parseFloat(southMatch[1]),
        east: parseFloat(eastMatch[1]),
        west: parseFloat(westMatch[1]),
      };
      
      log('Current bounds:', colors.blue);
      console.log(JSON.stringify(bounds, null, 2));
      
      // Validate bounds make sense
      const issues = [];
      if (bounds.north <= bounds.south) issues.push('North should be greater than South');
      if (bounds.east <= bounds.west) issues.push('East should be greater than West');
      if (Math.abs(bounds.north) > 90) issues.push('Latitude values should be between -90 and 90');
      if (Math.abs(bounds.south) > 90) issues.push('Latitude values should be between -90 and 90');
      if (Math.abs(bounds.east) > 180) issues.push('Longitude values should be between -180 and 180');
      if (Math.abs(bounds.west) > 180) issues.push('Longitude values should be between -180 and 180');
      
      if (issues.length > 0) {
        log('\n‚ùå Configuration Issues Found:', colors.red);
        issues.forEach(issue => log(`   - ${issue}`, colors.yellow));
        console.log();
      } else {
        log('\n‚úÖ Configuration values look valid!\n', colors.green);
      }
    }
  } catch (error) {
    log(`‚ùå Error validating configuration: ${error.message}`, colors.red);
  }
}

/**
 * Main menu
 */
function main() {
  log('\n' + '‚ïê'.repeat(60), colors.bright);
  log('  üìç GPS Map Bounds Configuration Tool', colors.bright + colors.blue);
  log('‚ïê'.repeat(60) + '\n', colors.bright);
  
  log('This tool helps you configure GPS coordinate transformation', colors.yellow);
  log('for accurate indoor navigation with GPS support.\n');
  
  // Run all functions
  validateConfiguration();
  calculateBoundsFromLocations();
  testGPSTransformation();
  generateConfigTemplate();
  
  // Final instructions
  header('üéØ Next Steps');
  log('1. Update DEFAULT_MAP_BOUNDS in src/config/mapConfig.ts', colors.green);
  log('2. Add GPS coordinates to your locations in DatabaseService.ts');
  log('3. Test GPS tracking in the app (outdoor mode)');
  log('4. Verify that GPS positions match QR code positions\n');
  
  log('üìö For more information, see:', colors.blue);
  log('   - src/config/mapConfig.ts');
  log('   - src/services/LocationService.ts');
  log('   - src/context/NavigationContext.tsx\n');
}

// Run the script
if (require.main === module) {
  main();
}

module.exports = {
  calculateBoundsFromLocations,
  testGPSTransformation,
  generateConfigTemplate,
  validateConfiguration,
};

